<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diagnosa Layu Fusarium</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }

    .chat-box {
      border: 1px solid #ccc;
      height: 720px;
      background: #eaeaea;
      padding: 20px;
    }

    .chat-log {
      max-height: 550px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .chat-bubble {
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 15px;
      display: inline-block;
      max-width: 80%;
    }

    .bot {
      background-color: #ffffff;
      align-self: flex-end;
    }

    .user {
      background-color: #0d6efd;
      color: white;
      align-self: flex-end;
      text-align: right;
    }

    .chat-image {
      max-width: 100%;
      width: 400px;
      border-radius: 10px;
      margin-top: 10px;
    }

    .back-link {
      text-decoration: none;
      color: #2c7be5;
      font-size: 20px;
      margin-right: 130px;
    }

    .btn-group {
      margin: 20px 0;
      width: 425px;
      max-width: 100%;
    }

    .offcanvas-body .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding-left: 10px;
    }

    .custom-shadow {
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
    }

    .lottie-icon {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-light sticky-top custom-shadow">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center text-black" href="dashboard.html">
        <!-- Lottie icon di kiri teks -->
        <lottie-player src="assets\chilli.json" background="transparent" speed="1" class="lottie-icon" loop autoplay>
        </lottie-player>
        Sistem Pakar Cabai
      </a>

      <!-- Tombol offcanvas hanya tampil di layar kecil -->
      <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Menu normal untuk layar besar -->
      <div class="collapse navbar-collapse d-none d-lg-block" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link text-black" href="penyakit.html"><i class="bi bi-bug"></i> Penyakit</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="gejala.html"><i class="bi bi-emoji-frown"></i> Gejala</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="basis_pengetahuan.html"><i class="bi bi-book"></i> Basis
              Pengetahuan</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-black" href="hotline_admin.html"><i class="bi bi-telephone"></i> Hotline</a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-bold text-black" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal"><i
                class="bi bi-box-arrow-right"></i> Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="chat-box">
    <h4 class="text-left mb-3">
      <a href="dashboard.html" class="back-link mb-3 d-inline-block">
        <i class="bi bi-arrow-left-circle"></i>
      </a>
      Diagnosa Layu Fusarium
    </h4>

    <div class="chat-log d-flex flex-column" id="chatLog"></div>

    <!-- Tombol Ya dan Tidak di kanan -->
    <div class="d-flex justify-content-end mt-3" id="btnGroup">
      <div class="btn-group d-flex flex-row" role="group">
        <button class="btn btn-success" onclick="submitPilihan('ya')">Ya</button>
        <button class="btn btn-danger" onclick="submitPilihan('tidak')">Tidak</button>
      </div>
    </div>
  </div>


  <!-- JS Diagnosa -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <script>
    const pertanyaan = [
      { teks: "Apakah daun menguning dari bawah ke atas?", cf: 0.392, img: "assets/menguning.jpg" },
      { teks: "Apakah tanaman layu siang hari dan segar sore hari?", cf: 0.44, img: "assets/layu.jpg" },
      { teks: "Apakah batang bagian bawah menghitam?", cf: 0.44, img: "assets/batang.jpg" },
      { teks: "Apakah akar membusuk?", cf: 0.424, img: "assets/busuk.jpg" },
      { teks: "Apakah daun rontok tiba-tiba?", cf: 0.368, img: "assets/rontok.jpg" },
      { teks: "Apakah tanaman mati perlahan?", cf: 0.416, img: "assets/mati.jpg" }
    ];

    let index = 0;
    let cfValues = [];
    let jawabanPengguna = [];

    function tampilkanBot(teks, imgUrl = null) {
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot';
      bubble.innerHTML = teks;
      if (imgUrl) {
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = "Gambar gejala";
        img.className = "chat-image";
        bubble.appendChild(document.createElement('br'));
        bubble.appendChild(img);
      }
      document.getElementById("chatLog").appendChild(bubble);
      scrollToBottom();
    }

    function tampilkanUser(teks) {
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble user ms-auto';
      bubble.textContent = teks;
      document.getElementById("chatLog").appendChild(bubble);
      scrollToBottom();
    }

    function scrollToBottom() {
      const chatLog = document.getElementById("chatLog");
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function submitPilihan(pilihan) {
      tampilkanUser(pilihan);
      cfValues.push(pilihan === "ya" ? pertanyaan[index].cf : 0);
      jawabanPengguna.push(pilihan);
      index++;

      setTimeout(() => {
        if (index < pertanyaan.length) {
          tampilkanBot(pertanyaan[index].teks, pertanyaan[index].img);
        } else {
          const hasil = hitungCF(cfValues);
          const persentase = (hasil * 100).toFixed(2);
          const kesimpulan = hasil >= 0.5
            ? `Kemungkinan besar tanaman terkena Layu Fusarium (${persentase}%)`
            : `Tanaman tidak menunjukkan gejala Layu Fusarium secara dominan (${persentase}%)`;

          const kesimpulanBox = `<div class='chat-bubble bot bg-warning-subtle'>
            <strong>${kesimpulan}</strong><br>
            <button class='btn btn-success btn-sm mt-2' onclick='downloadPDF(jawabanPengguna, "${kesimpulan}")'>Download Hasil Diagnosa (PDF)</button>
            <button class='btn btn-secondary btn-sm mt-2' onclick='location.reload()'>Diagnosa Ulang</button>
          </div>`;
          document.getElementById("chatLog").innerHTML += kesimpulanBox;
          document.getElementById("btnGroup").style.display = "none";
          scrollToBottom();
        }
      }, 500);
    }

    function hitungCF(values) {
      let result = values[0];
      for (let i = 1; i < values.length; i++) {
        result = result + values[i] * (1 - result);
      }
      return result;
    }

    function getSaran(positif) {
      if (positif) {
        return [
          "1. Cabut dan musnahkan tanaman yang terinfeksi untuk mencegah penyebaran.",
          "2. Gunakan fungisida sistemik berbahan aktif seperti benomil atau karbendazim.",
          "3. Lakukan rotasi tanaman, hindari menanam cabai pada lahan yang sama setiap musim.",
          "4. Pastikan drainase tanah baik dan tidak terlalu lembab.",
          "5. Gunakan varietas cabai yang tahan terhadap penyakit layu fusarium jika tersedia."
        ];
      } else {
        return [
          "1. Tanaman masih sehat, tetap lakukan monitoring rutin.",
          "2. Jaga kelembaban tanah tetap ideal dan tidak terlalu basah.",
          "3. Bersihkan gulma di sekitar tanaman agar tidak menjadi inang penyakit.",
          "4. Lakukan pemupukan secara seimbang untuk meningkatkan ketahanan tanaman."
        ];
      }
    }


    async function downloadPDF(jawaban, kesimpulan) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const tanggal = new Date().toLocaleString("id-ID");

      doc.setFontSize(16);
      doc.text("Laporan Diagnosa Layu Fusarium", 10, 15);
      doc.setFontSize(11);
      doc.text(`Tanggal Diagnosa: ${tanggal}`, 10, 23);
      doc.setFontSize(12);
      doc.text("Tabel Gejala dan Jawaban:", 10, 30);

      const headers = ["No", "Gejala", "Jawaban"];
      const body = pertanyaan.map((p, i) => [(i + 1).toString(), p.teks, jawaban[i]]);

      doc.autoTable({
        startY: 35,
        head: [headers],
        body: body,
        styles: { fontSize: 10, cellWidth: 'wrap' },
        headStyles: { fillColor: [22, 160, 133] },
        margin: { top: 30 }
      });

      const yKesimpulan = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(12);
      doc.text("Kesimpulan:", 10, yKesimpulan);
      doc.setFontSize(11);
      doc.text(doc.splitTextToSize(kesimpulan, 180), 10, yKesimpulan + 6);

      const saran = getSaran(kesimpulan.includes("Kemungkinan besar"));
      doc.setFontSize(12);
      doc.text("Saran Penanganan:", 10, yKesimpulan + 26);
      doc.setFontSize(11);
      doc.text(doc.splitTextToSize(saran.join("\n"), 180), 10, yKesimpulan + 32);

      doc.save("hasil_diagnosa_layu_fusarium.pdf");
    }

    tampilkanBot(pertanyaan[0].teks, pertanyaan[0].img);
  </script>

  <!-- Sidebar offcanvas untuk mobile -->
  <div class="offcanvas offcanvas-end text-bg-primary d-lg-none" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Menu Navigasi</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-4">
      <ul class="navbar-nav text-start fs-5">
        <li class="nav-item mb-2"><a class="nav-link text-white" href="penyakit.html"><i class="bi bi-bug me-2"></i>
            Penyakit</a></li>
        <li class="nav-item mb-2"><a class="nav-link text-white" href="gejala.html"><i
              class="bi bi-emoji-frown me-2"></i> Gejala</a></li>
        <li class="nav-item mb-2"><a class="nav-link text-white" href="basis_pengetahuan.html"><i
              class="bi bi-book me-2"></i> Basis Pengetahuan</a></li>
        <li class="nav-item mb-2"><a class="nav-link text-white" href="hotline_admin.html"><i
              class="bi bi-telephone me-2"></i> Hotline</a></li>
        <li class="nav-item mt-3"><a class="nav-link text-white fw-bold" href="#" data-bs-toggle="modal"
            data-bs-target="#logoutModal"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
      </ul>
    </div>
  </div>

  <!-- Modal Logout -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">Konfirmasi Logout</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p>Apakah Anda yakin ingin keluar dari sistem?</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <a href="index.html" class="btn btn-danger">Logout</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>